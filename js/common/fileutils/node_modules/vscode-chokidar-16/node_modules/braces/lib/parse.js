"use strict";const stringify=require("./stringify"),{MAX_LENGTH:MAX_LENGTH,CHAR_BACKSLASH:CHAR_BACKSLASH,CHAR_BACKTICK:CHAR_BACKTICK,CHAR_COMMA:CHAR_COMMA,CHAR_DOT:CHAR_DOT,CHAR_LEFT_PARENTHESES:CHAR_LEFT_PARENTHESES,CHAR_RIGHT_PARENTHESES:CHAR_RIGHT_PARENTHESES,CHAR_LEFT_CURLY_BRACE:CHAR_LEFT_CURLY_BRACE,CHAR_RIGHT_CURLY_BRACE:CHAR_RIGHT_CURLY_BRACE,CHAR_LEFT_SQUARE_BRACKET:CHAR_LEFT_SQUARE_BRACKET,CHAR_RIGHT_SQUARE_BRACKET:CHAR_RIGHT_SQUARE_BRACKET,CHAR_DOUBLE_QUOTE:CHAR_DOUBLE_QUOTE,CHAR_SINGLE_QUOTE:CHAR_SINGLE_QUOTE,CHAR_NO_BREAK_SPACE:CHAR_NO_BREAK_SPACE,CHAR_ZERO_WIDTH_NOBREAK_SPACE:CHAR_ZERO_WIDTH_NOBREAK_SPACE}=require("./constants"),parse=(e,t={})=>{if("string"!=typeof e)throw new TypeError("Expected a string");let A=t||{},_="number"==typeof A.maxLength?Math.min(MAX_LENGTH,A.maxLength):MAX_LENGTH;if(e.length>_)throw new SyntaxError(`Input length (${e.length}), exceeds max characters (${_})`);let R,C={type:"root",input:e,nodes:[]},E=[C],n=C,H=C,l=0,s=e.length,p=0,o=0;const a=()=>e[p++],i=e=>{if("text"===e.type&&"dot"===H.type&&(H.type="text"),!H||"text"!==H.type||"text"!==e.type)return n.nodes.push(e),e.parent=n,e.prev=H,H=e,e;H.value+=e.value};for(i({type:"bos"});p<s;)if(n=E[E.length-1],R=a(),R!==CHAR_ZERO_WIDTH_NOBREAK_SPACE&&R!==CHAR_NO_BREAK_SPACE)if(R!==CHAR_BACKSLASH)if(R!==CHAR_RIGHT_SQUARE_BRACKET)if(R!==CHAR_LEFT_SQUARE_BRACKET)if(R!==CHAR_LEFT_PARENTHESES)if(R!==CHAR_RIGHT_PARENTHESES)if(R!==CHAR_DOUBLE_QUOTE&&R!==CHAR_SINGLE_QUOTE&&R!==CHAR_BACKTICK)if(R!==CHAR_LEFT_CURLY_BRACE)if(R!==CHAR_RIGHT_CURLY_BRACE)if(R===CHAR_COMMA&&o>0){if(n.ranges>0){n.ranges=0;let e=n.nodes.shift();n.nodes=[e,{type:"text",value:stringify(n)}]}i({type:"comma",value:R}),n.commas++}else if(R===CHAR_DOT&&o>0&&0===n.commas){let e=n.nodes;if(0===o||0===e.length){i({type:"text",value:R});continue}if("dot"===H.type){if(n.range=[],H.value+=R,H.type="range",3!==n.nodes.length&&5!==n.nodes.length){n.invalid=!0,n.ranges=0,H.type="text";continue}n.ranges++,n.args=[];continue}if("range"===H.type){e.pop();let t=e[e.length-1];t.value+=H.value+R,H=t,n.ranges--;continue}i({type:"dot",value:R})}else i({type:"text",value:R});else{if("brace"!==n.type){i({type:"text",value:R});continue}let e="close";n=E.pop(),n.close=!0,i({type:e,value:R}),o--,n=E[E.length-1]}else{o++;let e=H.value&&"$"===H.value.slice(-1)||!0===n.dollar;n=i({type:"brace",open:!0,close:!1,dollar:e,depth:o,commas:0,ranges:0,nodes:[]}),E.push(n),i({type:"open",value:R})}else{let e,A=R;for(!0!==t.keepQuotes&&(R="");p<s&&(e=a());)if(e!==CHAR_BACKSLASH){if(e===A){!0===t.keepQuotes&&(R+=e);break}R+=e}else R+=e+a();i({type:"text",value:R})}else{if("paren"!==n.type){i({type:"text",value:R});continue}n=E.pop(),i({type:"text",value:R}),n=E[E.length-1]}else n=i({type:"paren",nodes:[]}),E.push(n),i({type:"text",value:R});else{l++;let e;for(;p<s&&(e=a());)if(R+=e,e!==CHAR_LEFT_SQUARE_BRACKET)if(e!==CHAR_BACKSLASH){if(e===CHAR_RIGHT_SQUARE_BRACKET&&(l--,0===l))break}else R+=a();else l++;i({type:"text",value:R})}else i({type:"text",value:"\\"+R});else i({type:"text",value:(t.keepEscaping?R:"")+a()});do{if(n=E.pop(),"root"!==n.type){n.nodes.forEach((e=>{e.nodes||("open"===e.type&&(e.isOpen=!0),"close"===e.type&&(e.isClose=!0),e.nodes||(e.type="text"),e.invalid=!0)}));let e=E[E.length-1],t=e.nodes.indexOf(n);e.nodes.splice(t,1,...n.nodes)}}while(E.length>0);return i({type:"eos"}),C};module.exports=parse;
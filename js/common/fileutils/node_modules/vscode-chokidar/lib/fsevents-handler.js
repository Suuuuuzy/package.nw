"use strict";var fsevents,fs=require("fs"),sysPath=require("path"),readdirp=require("readdirp");try{fsevents=require("vscode-fsevents")}catch(t){}var FSEventsWatchers=Object.create(null),consolidateThreshhold=10;function createFSEventsInstance(t,e){return new fsevents(t).on("fsevent",e).start()}function setFSEventsListener(t,e,s,i){var n,r=sysPath.extname(t)?sysPath.dirname(t):t,a=sysPath.dirname(r);couldConsolidate(a)&&(r=a);var h=sysPath.resolve(t),o=h!==e;function d(t,i,n){o&&(t=t.replace(e,h)),t!==h&&t.indexOf(h+sysPath.sep)||s(t,i,n)}r in FSEventsWatchers||Object.keys(FSEventsWatchers).some((function(t){if(!e.indexOf(sysPath.resolve(t)+sysPath.sep))return r=t,!0}))?(n=FSEventsWatchers[r]).listeners.push(d):n=FSEventsWatchers[r]={listeners:[d],rawEmitters:[i],watcher:createFSEventsInstance(r,(function(t,e){var s=fsevents.getInfo(t,e);n.listeners.forEach((function(i){i(t,e,s)})),n.rawEmitters.forEach((function(e){e(s.event,t,s)}))}))};var c=n.listeners.length-1;return function(){delete n.listeners[c],delete n.rawEmitters[c],Object.keys(n.listeners).length||(n.watcher.stop(),delete FSEventsWatchers[r])}}function couldConsolidate(t){for(var e=Object.keys(FSEventsWatchers),s=0,i=0,n=e.length;i<n;++i){if(0===e[i].indexOf(t)&&++s>=consolidateThreshhold)return!0}return!1}function canUse(){return fsevents&&Object.keys(FSEventsWatchers).length<128}function depth(t,e){for(var s=0;!t.indexOf(e)&&(t=sysPath.dirname(t))!==e;)s++;return s}function FsEventsHandler(){}FsEventsHandler.prototype._watchWithFsEvents=function(t,e,s,i){if(!this._isIgnored(t)){var n=function(n,r,a){if(!(void 0!==this.options.depth&&depth(n,e)>this.options.depth)){var h=s(sysPath.join(t,sysPath.relative(t,n)));if(!i||i(h)){var o=sysPath.dirname(h),d=sysPath.basename(h),c=this._getWatchedDir("directory"===a.type?h:o),f=function(t){if(this._isIgnored(h,t))return this._ignoredPaths[h]=!0,t&&t.isDirectory()&&(this._ignoredPaths[h+"/**/*"]=!0),!0;delete this._ignoredPaths[h],delete this._ignoredPaths[h+"/**/*"]}.bind(this),l=function(t){if(!f())if("unlink"===t)("directory"===a.type||c.has(d))&&this._remove(o,d);else{if("add"===t){if("directory"===a.type&&this._getWatchedDir(h),"symlink"===a.type&&this.options.followSymlinks){var s=void 0===this.options.depth?void 0:depth(n,e)+1;return this._addToFsEvents(h,!1,!0,s)}this._getWatchedDir(o).add(d)}var i="directory"===a.type?t+"Dir":t;this._emit(i,h),"addDir"===i&&this._addToFsEvents(h,!1,!0)}}.bind(this);if(-1!==[69888,70400,71424,72704,73472,131328,131840,262912].indexOf(r)||"unknown"===a.event)"function"==typeof this.options.ignored?fs.stat(h,(function(t,e){f(e)||(e?u():l("unlink"))})):v();else switch(a.event){case"created":case"modified":return u();case"deleted":case"moved":return v()}}}function u(){l(c.has(d)?"change":"add")}function v(){fs.open(h,"r",(function(t,e){e&&fs.close(e),t&&"EACCES"!==t.code?l("unlink"):u()}))}}.bind(this),r=setFSEventsListener(t,e,n,this.emit.bind(this,"raw"));return this._emitReady(),r}},FsEventsHandler.prototype._handleFsEventsSymlink=function(t,e,s,i){this._symlinkPaths[e]||(this._symlinkPaths[e]=!0,this._readyCount++,fs.realpath(t,function(e,n){if(this._handleError(e)||this._isIgnored(n))return this._emitReady();this._readyCount++,this._addToFsEvents(n||t,(function(e){var i="."+sysPath.sep,r=t;return n&&n!==i?r=e.replace(n,t):e!==i&&(r=sysPath.join(t,e)),s(r)}),!1,i)}.bind(this)))},FsEventsHandler.prototype._addToFsEvents=function(t,e,s,i){var n="function"==typeof e?e:function(t){return t},r=function(t,e){var i=n(t),r=e.isDirectory(),a=this._getWatchedDir(sysPath.dirname(i)),h=sysPath.basename(i);r&&this._getWatchedDir(i),a.has(h)||(a.add(h),this.options.ignoreInitial&&!0!==s||this._emit(r?"addDir":"add",i,e))}.bind(this),a=this._getWatchHelpers(t);if(fs[a.statMethod](a.watchPath,function(e,s){if(this._handleError(e)||this._isIgnored(a.watchPath,s))return this._emitReady(),this._emitReady();if(s.isDirectory()){if(a.globFilter||r(n(t),s),i&&i>this.options.depth)return;readdirp({root:a.watchPath,entryType:"all",fileFilter:a.filterPath,directoryFilter:a.filterDir,lstat:!0,depth:this.options.depth-(i||0)}).on("data",function(t){if(!t.stat.isDirectory()||a.filterPath(t)){var e=sysPath.join(a.watchPath,t.path),s=t.fullPath;if(a.followSymlinks&&t.stat.isSymbolicLink()){var i=void 0===this.options.depth?void 0:depth(e,sysPath.resolve(a.watchPath))+1;this._handleFsEventsSymlink(e,s,n,i)}else r(e,t.stat)}}.bind(this)).on("error",(function(){})).on("end",this._emitReady)}else r(a.watchPath,s),this._emitReady()}.bind(this)),this.options.persistent&&!0!==s){var h=function(e,s){if(!this.closed){var i=this._watchWithFsEvents(a.watchPath,sysPath.resolve(s||a.watchPath),n,a.globFilter);i&&(this._closers[t]=i)}}.bind(this);"function"==typeof e?h():fs.realpath(a.watchPath,h)}},module.exports=FsEventsHandler,module.exports.canUse=canUse;
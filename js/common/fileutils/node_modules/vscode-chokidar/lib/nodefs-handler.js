"use strict";var fs=require("fs"),sysPath=require("path"),readdirp=require("readdirp"),isBinaryPath=require("is-binary-path"),FsWatchInstances=Object.create(null);function createFsWatchInstance(t,e,s,i,r){try{return fs.watch(t,e,(function(e,i){s(t),r(e,i,{watchedPath:t}),i&&t!==i&&fsWatchBroadcast(sysPath.resolve(t,i),"listeners",sysPath.join(t,i))}))}catch(t){i(t)}}function fsWatchBroadcast(t,e,s,i,r){FsWatchInstances[t]&&FsWatchInstances[t][e].forEach((function(t){t(s,i,r)}))}function setFsWatchListener(t,e,s,i){var r,a=i.listener,n=i.errHandler,h=i.rawEmitter,l=FsWatchInstances[e];if(!s.persistent)return(r=createFsWatchInstance(t,s,a,n,h)).close.bind(r);if(l)l.listeners.push(a),l.errHandlers.push(n),l.rawEmitters.push(h);else{if(!(r=createFsWatchInstance(t,s,fsWatchBroadcast.bind(null,e,"listeners"),n,fsWatchBroadcast.bind(null,e,"rawEmitters"))))return;var o=fsWatchBroadcast.bind(null,e,"errHandlers");r.on("error",(function(e){"win32"===process.platform&&"EPERM"===e.code?fs.open(t,"r",(function(t,s){s&&fs.close(s),t||o(e)})):o(e)})),l=FsWatchInstances[e]={listeners:[a],errHandlers:[n],rawEmitters:[h],watcher:r}}var c=l.listeners.length-1;return function(){delete l.listeners[c],delete l.errHandlers[c],delete l.rawEmitters[c],Object.keys(l.listeners).length||(l.watcher.close(),delete FsWatchInstances[e])}}var FsWatchFileInstances=Object.create(null);function setFsWatchFileListener(t,e,s,i){var r=i.listener,a=i.rawEmitter,n=FsWatchFileInstances[e],h=[],l=[];n&&(n.options.persistent<s.persistent||n.options.interval>s.interval)&&(h=n.listeners,l=n.rawEmitters,fs.unwatchFile(e),n=!1),n?(n.listeners.push(r),n.rawEmitters.push(a)):(h.push(r),l.push(a),n=FsWatchFileInstances[e]={listeners:h,rawEmitters:l,options:s,watcher:fs.watchFile(e,s,(function(s,i){n.rawEmitters.forEach((function(t){t("change",e,{curr:s,prev:i})}));var r=s.mtime.getTime();(s.size!==i.size||r>i.mtime.getTime()||0===r)&&n.listeners.forEach((function(e){e(t,s)}))}))});var o=n.listeners.length-1;return function(){delete n.listeners[o],delete n.rawEmitters[o],Object.keys(n.listeners).length||(fs.unwatchFile(e),delete FsWatchFileInstances[e])}}function NodeFsHandler(){}NodeFsHandler.prototype._watchWithNodeFs=function(t,e){var s=sysPath.dirname(t),i=sysPath.basename(t);this._getWatchedDir(s).add(i);var r,a=sysPath.resolve(t),n={persistent:this.options.persistent};return e||(e=Function.prototype),this.options.usePolling?(n.interval=this.enableBinaryInterval&&isBinaryPath(i)?this.options.binaryInterval:this.options.interval,r=setFsWatchFileListener(t,a,n,{listener:e,rawEmitter:this.emit.bind(this,"raw")})):r=setFsWatchListener(t,a,n,{listener:e,errHandler:this._handleError.bind(this),rawEmitter:this.emit.bind(this,"raw")}),r},NodeFsHandler.prototype._handleFile=function(t,e,s,i){var r=sysPath.dirname(t),a=sysPath.basename(t),n=this._getWatchedDir(r);if(n.has(a))return i();var h=this._watchWithNodeFs(t,function(e,s){this._throttle("watch",t,5)&&(!s||s&&0===s.mtime.getTime()?fs.stat(t,function(e,s){e?this._remove(r,a):this._emit("change",t,s)}.bind(this)):n.has(a)&&this._emit("change",t,s))}.bind(this));if(!s||!this.options.ignoreInitial){if(!this._throttle("add",t,0))return;this._emit("add",t,e)}return i&&i(),h},NodeFsHandler.prototype._handleSymlink=function(t,e,s,i){var r=t.fullPath,a=this._getWatchedDir(e);return this.options.followSymlinks?!!this._symlinkPaths[r]||void(this._symlinkPaths[r]=!0):(this._readyCount++,fs.realpath(s,function(e,n){a.has(i)?this._symlinkPaths[r]!==n&&(this._symlinkPaths[r]=n,this._emit("change",s,t.stat)):(a.add(i),this._symlinkPaths[r]=n,this._emit("add",s,t.stat)),this._emitReady()}.bind(this)),!0)},NodeFsHandler.prototype._handleDir=function(t,e,s,i,r,a,n){var h=this._getWatchedDir(sysPath.dirname(t)),l=h.has(sysPath.basename(t));s&&this.options.ignoreInitial||r||l||a.hasGlob&&!a.globFilter(t)||this._emit("addDir",t,e),h.add(sysPath.basename(t)),this._getWatchedDir(t);var o,c=function(e,s,n){if(e=sysPath.join(e,""),!a.hasGlob){var h=this._throttle("readdir",e,1e3);if(!h)return}var l=this._getWatchedDir(a.path),o=[];readdirp({root:e,entryType:"all",fileFilter:a.filterPath,directoryFilter:a.filterDir,depth:0,lstat:!0}).on("data",function(n){var h=n.path,c=sysPath.join(e,h);o.push(h),n.stat.isSymbolicLink()&&this._handleSymlink(n,e,c,h)||h!==r&&(r||l.has(h))||(this._readyCount++,c=sysPath.join(t,sysPath.relative(t,c)),this._addToNodeFs(c,s,a,i+1))}.bind(this)).on("end",function(){h&&h.clear(),n&&n(),l.children().filter((function(t){return t!==e&&-1===o.indexOf(t)&&(!a.hasGlob||a.filterPath({fullPath:sysPath.resolve(e,t)}))})).forEach((function(t){this._remove(e,t)}),this)}.bind(this)).on("error",this._handleError.bind(this))}.bind(this);return null==this.options.depth||i<=this.options.depth?(r||c(t,s,n),o=this._watchWithNodeFs(t,(function(t,e){e&&0===e.mtime.getTime()||c(t,!1)}))):n(),o},NodeFsHandler.prototype._addToNodeFs=function(t,e,s,i,r,a){a||(a=Function.prototype);var n=this._emitReady;if(this._isIgnored(t)||this.closed)return n(),a(null,!1);var h=this._getWatchHelpers(t,i);!h.hasGlob&&s&&(h.hasGlob=s.hasGlob,h.globFilter=s.globFilter,h.filterPath=s.filterPath,h.filterDir=s.filterDir),fs[h.statMethod](h.watchPath,function(s,l){if(this._handleError(s))return a(null,t);if(this._isIgnored(h.watchPath,l))return n(),a(null,!1);var o,c=function(t,s){return this._handleDir(t,l,e,i,s,h,n)}.bind(this);if(l.isDirectory())o=c(h.watchPath,r);else if(l.isSymbolicLink()){var d=sysPath.dirname(h.watchPath);this._getWatchedDir(d).add(h.watchPath),this._emit("add",h.watchPath,l),o=c(d,t),fs.realpath(t,function(e,s){this._symlinkPaths[sysPath.resolve(t)]=s,n()}.bind(this))}else o=this._handleFile(h.watchPath,l,e,n);o&&(this._closers[t]=o),a(null,!1)}.bind(this))},module.exports=NodeFsHandler;